<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>JNI | Goverse&#39;Blog | Think more and different</title>

  

  
  <meta name="description" content="JNI是什么？
JNI的全称就是Java Native Interface，顾名思义，就是Java和C/C++相互通信的接口，就好比买卖房子都需要找中介一样，这里的JNI就是Java和C/C++通信的中介，一个中间人。">
  

  
  
  <meta name="keywords" content="C++">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="JNI"/>

  <meta property="og:site_name" content="Goverse&#39;Blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Goverse&#39;Blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>

</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Goverse&#39;Blog</a>
    </h1>
    <p class="site-description">Think more and different</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/categories">分类</a></li>
      
        <li><a href="/about">关于</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>JNI</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/tech/jni.html" rel="bookmark">
        <time class="entry-date published" datetime="2017-11-08T09:30:00.000Z">
          2017-11-08
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <script src="/assets/js/APlayer.min.js"> </script><p>JNI是什么？</p>
<p>JNI的全称就是Java Native Interface，顾名思义，就是Java和C/C++相互通信的接口，就好比买卖房子都需要找中介一样，这里的JNI就是Java和C/C++通信的中介，一个中间人。<br><a id="more"></a><br>JNI头文件</p>
<p>JNI开发前提是要引入jni.h头文件，这个文件Android NDK目录下面</p>
<p>怎么加载so库？</p>
<p>Android提供了3个实用的函数用来加载JNI库，分别是System.loadLibrary(libname)，Runtime.getRuntime().loadLibrary(libname)，以及Runtime.getRuntime().load(libFilePath)。</p>
<p>用loadLibrary函数加载</p>
<p>用System.loadLibrary(libname)和Runtime.getRuntime().loadLibrary(libname)这两个函数加载so库，不需要指定so库的路径，Android会默认从系统的共享库目录里面去查找，Android的共享库目录就是vendor/lib和system/lib，如果在共享库路径里面找到指定名字的so库，就会立即加载这个so库，所以我们给so库起名的时候要尽量避免和Android共享库里面的so库同名。如果在共享库目录里面查找不到，就会在APP的安装目录里面查找APP的私有so库，如果查找到，会立即加载这个so库。</p>
<p>用load函数加载</p>
<p>Runtime.getRuntime().load(libFilePath)用这个函数加载so库，需要指定完整的so库路径，优点是加载速度快，并且不会加载错误的so库，缺点就是需要指定完整的so库路径，有时候并不方便，大家常用的加载so库的方式还是用loadLibrary函数来加载。</p>
<p>加载so库示例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">static &#123;</div><div class="line">​    System.loadLibrary(&quot;native-lib&quot;);</div><div class="line">​    //用这种方式加载so库和System.loadLibrary函数加载so库的效果是一样的</div><div class="line">​    //Runtime.getRuntime().loadLibrary(&quot;native-lib&quot;);</div><div class="line">​    //String soLibFilePath;</div><div class="line">​    //用这种方式加载so库需要指定完整的so库路径</div><div class="line">​    //Runtime.getRuntime().load(soLibFilePath);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Android Studio so库配置</p>
<p>Android Studio通过CMakeLists.txt文件配置需要生成的so库，下面详细给大家介绍一下这个CMakeLists.txt文件如何配置。</p>
<p>Android Studio通过cmake命令来生成so库。</p>
<p>CMakeLists.txt文件配置详解</p>
<p>add_library</p>
<p>add_library函数用来配置要生成的so库的基本信息，比如库的名字，要生成的so库是静态的还是共享的，so库的C/C++源文件列表</p>
<p>示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">add_library( native-lib</div><div class="line">​             SHARED</div><div class="line">​             src/main/cpp/native-lib.cpp</div><div class="line">​             src/main/cpp/native-lib2.cpp</div><div class="line">​             src/main/cpp/native-lib3.cpp)</div></pre></td></tr></table></figure>
<p>第一个参数是so库的名字</p>
<p>第二个参数是要生成的so库的类型，静态so库是STATIC,共享so库是SHARED</p>
<p>第三个参数是C/C++源文件，可以包括多个源文件</p>
<p>find_library</p>
<p>find_library函数用来从NDK目录下面查找特定的so库</p>
<p>示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">find_library( log-lib</div><div class="line">​              log )</div></pre></td></tr></table></figure>
<p>第一个参数是我们给要查找的so库起的名字，名字可以随便写</p>
<p>第二个参数是要查找的so库的名字，这个名字是从真实的so库的名字去掉前缀和后缀后的名字，比如liblog.so这个so库的名字就是log</p>
<p>target_link_libraries</p>
<p>target_link_libraries函数用来把要生成的so库和依赖的其它so库进行链接，生成我们需要的so库文件</p>
<p>示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">target_link_libraries( native-lib</div><div class="line">​                       $&#123;log-lib&#125; )</div></pre></td></tr></table></figure></p>
<p>第一个参数是我们要生成的so库的名字去掉前缀和后缀后的名字，在这个例子中，要生成的真实的so库的名字是libnative-lib.so</p>
<p>第二个参数是链接我们用find_library函数定义的查找的依赖库的名字log-lib，语法就是${依赖的库的名字}</p>
<p>JNI函数详解</p>
<p>JNI字符串相关的函数</p>
<p>C/C++字符串转JNI字符串</p>
<p>NewString函数用来生成Unicode JNI字符串</p>
<p>NewStringUTF函数用来生成UTF-8 JNI字符串</p>
<p>示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_testJString(JNIEnv* env, jobject thiz,jstring jstr) &#123;</div><div class="line">​    char *str=&quot;helloboy&quot;;</div><div class="line">​    jstring jstr2=env-&gt;NewStringUTF(str);</div><div class="line"></div><div class="line">    const jchar *jchar2=env-&gt;GetStringChars(jstr,NULL);</div><div class="line">    size_t len=env-&gt;GetStringLength(jstr);</div><div class="line">    jstring jstr3=env-&gt;NewString(jchar2,len);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>JNI字符串转C/C++字符串</p>
<p>GetStringChars函数用来从jstring获取Unicode C/C++字符串</p>
<p>GetStringUTFChars函数用来从jstring获取UTF-8 C/C++字符串</p>
<p>示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_testJString(JNIEnv* env, jobject thiz,jstring jstr) &#123;</div><div class="line">​    const char *str=env-&gt;GetStringUTFChars(jstr,NULL);</div><div class="line">​    const jchar *jchar2=env-&gt;GetStringChars(jstr,NULL);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>释放JNI字符串</p>
<p>ReleaseStringChars函数用来释放Unicode C/C++字符串</p>
<p>ReleaseStringUTFChars函数用来释放UTF-8 C/C++字符串</p>
<p>示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_testJString(JNIEnv* env, jobject thiz,jstring jstr) &#123;</div><div class="line">​    const char *str=env-&gt;GetStringUTFChars(jstr,NULL);</div><div class="line">   env-&gt;ReleaseStringUTFChars(jstr,str);</div><div class="line">​    </div><div class="line">​    const jchar *jchar2=env-&gt;GetStringChars(jstr,NULL);</div><div class="line">   env-&gt;ReleaseStringChars(jstr,jchar2);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>JNI字符串截取</p>
<p>GetStringRegion函数用来截取Unicode JNI字符串</p>
<p>GetStringUTFRegion函数用来截取UTF-8 JNI字符串</p>
<p>示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_testJString(JNIEnv* env, jobject thiz,jstring jstr) &#123;</div><div class="line">​    const char *str=env-&gt;GetStringUTFChars(jstr,NULL);</div><div class="line">​    char *subStr=new char;</div><div class="line">​    env-&gt;GetStringUTFRegion(jstr,0,3,subStr);</div><div class="line">   env-&gt;ReleaseStringUTFChars(jstr,str);</div><div class="line"></div><div class="line">    const jchar *jchar2=env-&gt;GetStringChars(jstr,NULL);</div><div class="line">    jchar *subJstr=new jchar;</div><div class="line">    env-&gt;GetStringRegion(jstr,0,3,subJstr);</div><div class="line">   env-&gt;ReleaseStringChars(jstr,jchar2);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>获取JNI字符串的长度</p>
<p>GetStringLength用来获取Unicode JNI字符串的长度</p>
<p>GetStringUTFLength函数用来获取UTF-8 JNI字符串的长度</p>
<p>示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_testJString(JNIEnv* env, jobject thiz,jstring jstr) &#123;</div><div class="line">​    jsize len=env-&gt;GetStringLength(jstr);</div><div class="line">​    jsize len2=env-&gt;GetStringUTFLength(jstr);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>获取JNI基本类型数组元素</p>
<p>Get<type>ArrayElements函数用来获取基本类型JNI数组的元素，这里面的<type>需要被替换成实际的类型，比如GetIntArrayElements，GetLongArrayElements等</type></type></p>
<p>示例代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_testJIntArray(JNIEnv* env, jobject thiz,jintArray array) &#123;</div><div class="line">​    jint *intArray=env-&gt;GetIntArrayElements(array,NULL);</div><div class="line">​    int len=env-&gt;GetArrayLength(array);</div><div class="line">​    for(int i=0;i&lt;len;i++)&#123;</div><div class="line">​        jint item=intArray[i];</div><div class="line">​    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>获取JNI基本类型数组的子数组</p>
<p>Get<type>ArrayRegion函数用来获取JNI数组的子数组，这里面的<type>需要被替换成实际的类型，比如GetIntArrayRegion，GetLongArrayRegion等</type></type></p>
<p>示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_testJIntArray(JNIEnv* env, jobject thiz,jintArray array) &#123;</div><div class="line">​    jint *subArray=new jint;</div><div class="line">​    env-&gt;GetIntArrayRegion(array,0,3,subArray);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>设置JNI基本类型数组的子数组</p>
<p>Set<type>ArrayRegion函数用来获取JNI基本类型数组的子数组，这里面的<type>需要被替换成实际的类型，比如SetIntArrayRegion，SetLongArrayRegion等</type></type></p>
<p>示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_testJIntArray(JNIEnv* env, jobject thiz,jintArray array) &#123;</div><div class="line">​    jint *subArray=new jint;</div><div class="line">​    env-&gt;GetIntArrayRegion(array,0,3,subArray);</div><div class="line">​    env-&gt;SetIntArrayRegion(array,0,3,subArray);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>JNI对象数组</p>
<p>GetObjectArrayElement函数用来获取JNI对象数组元素</p>
<p>SetObjectArrayElement函数用来设置JNI对象数组元素</p>
<p>示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_testJObjectArray(JNIEnv* env, jobject thiz,jobjectArray array) &#123;</div><div class="line">​    int len=env-&gt;GetArrayLength(array);</div><div class="line">​    for(int i=0;i&lt;len;i++)</div><div class="line">​    &#123;</div><div class="line">​        jobject item=env-&gt;GetObjectArrayElement(array,i);</div><div class="line">​    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_testJStringArray(JNIEnv* env, jobject thiz,jobjectArray array) &#123;</div><div class="line">​    int len=env-&gt;GetArrayLength(array);</div><div class="line">​    for(int i=0;i&lt;len;i++)</div><div class="line">​    &#123;</div><div class="line">​        jstring item=(jstring)env-&gt;GetObjectArrayElement(array,i);</div><div class="line">​    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_testJObjectArray(JNIEnv* env, jobject thiz,jobjectArray array) &#123;</div><div class="line">​    jobject obj;</div><div class="line">​    env-&gt;SetObjectArrayElement(array,1,obj);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>获取JNI数组的长度</p>
<p>GetArrayLength用来获取数组的长度</p>
<p>示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_testJObjectArray(JNIEnv* env, jobject thiz,jobjectArray array) &#123;</div><div class="line">​    int len=env-&gt;GetArrayLength(array);</div><div class="line">&#125;</div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_testJIntArray(JNIEnv* env, jobject thiz,jintArray array) &#123;</div><div class="line">​    int len=env-&gt;GetArrayLength(array);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>JNI访问Java类的方法和字段</p>
<p>JNI访问Java类方法相关的函数</p>
<p>JNI访问Java类的实例方法</p>
<p>GetObjectClass函数用来获取Java对象对应的类类型</p>
<p>GetMethodID函数用来获取Java类实例方法的方法ID</p>
<p>Call<type>Method函数用来调用Java类实例特定返回值的方法，比如CallVoidMethod，调用java没有返回值的方法，CallLongMethod用来调用Java返回值为Long的方法，等等。</type></p>
<p>示例如下：</p>
<p>Java代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">public native void callJavaHelloWorld2();</div><div class="line"></div><div class="line">public void helloWorld2(String msg)&#123;</div><div class="line">​    Log.i(&quot;hello&quot;,&quot;hello world &quot;+msg);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>JNI代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_callJavaHelloWorld2(JNIEnv* env, jobject thiz) &#123;</div><div class="line">​    jclass clazz=env-&gt;GetObjectClass(thiz);</div><div class="line">​    if(clazz==NULL) return;</div><div class="line">​    jmethodID helloWorld2_methodID=env-&gt;GetMethodID(clazz,&quot;helloWorld2&quot;,&quot;(java/lang/String;)V&quot;);</div><div class="line">​    if(helloWorld2_methodID==NULL) return;</div><div class="line">​    const char *msg=&quot;hello world&quot;;</div><div class="line">​    jstring jmsg=env-&gt;NewStringUTF(msg);</div><div class="line">​    env-&gt;CallVoidMethod(thiz,helloWorld2_methodID,jmsg);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>JNI访问Java类的静态方法</p>
<p>GetObjectClass函数用来获取Java对象对应的类类型</p>
<p>GetStaticMethodID函数用来获取Java类静态方法的方法ID</p>
<p>CallStatic<type>Method函数用来调用Java类特定返回值的静态方法，比如CallStaticVoidMethod，调用java没有返回值的静态方法，CallStaticLongMethod用来调用Java返回值为Long的静态方法，等等。</type></p>
<p>示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">Java代码：</div><div class="line"></div><div class="line">public native void callStaticJavaHelloWorld2();</div><div class="line"></div><div class="line">public static void helloWorldStatic2(String msg)&#123;</div><div class="line">​    Log.i(&quot;hello&quot;,&quot;hello world static &quot;+msg);</div><div class="line">&#125;</div><div class="line">JNI代码：</div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_callStaticJavaHelloWorld2(JNIEnv* env, jobject thiz) &#123;</div><div class="line">​    jclass clazz=env-&gt;GetObjectClass(thiz);</div><div class="line">​    if(clazz==NULL) return;</div><div class="line">​    jmethodID helloWorldStatic2_methodID=env-&gt;GetStaticMethodID(clazz,&quot;helloWorldStatic2&quot;,&quot;(java/lang/String;)V&quot;);</div><div class="line">​    if(helloWorldStatic2_methodID==NULL) return;</div><div class="line">​    const char *msg=&quot;hello world&quot;;</div><div class="line">​    jstring jmsg=env-&gt;NewStringUTF(msg);</div><div class="line">​    env-&gt;CallStaticVoidMethod(clazz,helloWorldStatic2_methodID,msg);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>JNI访问Java类字段相关的函数</p>
<p>JNI访问Java类实例字段</p>
<p>GetFieldID函数用来获取Java字段的字段ID</p>
<p>Get<type>Field用来获取Java类字段的值，比如用GetIntField函数获取Java int型字段的值，用GetLongField函数获取Java long字段的值，用GetObjectField函数获取Java引用类型字段的值</type></p>
<p>示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">Java代码：</div><div class="line"></div><div class="line">public class Person&#123;</div><div class="line">​    public String name;</div><div class="line">​    public int age;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public native void getJavaObjectField(Person person);</div><div class="line"></div><div class="line">private void test()&#123;</div><div class="line">​    Person person=new Person();</div><div class="line">​    person.name=&quot;wubb&quot;;</div><div class="line">​    person.age=20;</div><div class="line">​    getJavaObjectField(person);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">JNI代码：</div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_getJavaObjectField(JNIEnv* env, jobject thiz,jobject person) &#123;</div><div class="line">​    jclass clazz=env-&gt;GetObjectClass(person);</div><div class="line">​    jfieldID name_fieldID=env-&gt;GetFieldID(clazz,&quot;name&quot;,&quot;Ljava/lang/String;&quot;);</div><div class="line">​    jstring name=(jstring) env-&gt;GetObjectField(person,name_fieldID);</div><div class="line"></div><div class="line">    jfieldID age_fieldID=env-&gt;GetFieldID(clazz,&quot;age&quot;,&quot;I&quot;);</div><div class="line">    jint age=env-&gt;GetIntField(person,age_fieldID);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>JNI访问Java类静态字段</p>
<p>GetStaticFieldID函数用来获取Java静态字段的字段ID</p>
<p>GetStatic<type>Field用来获取Java类静态字段的值，比如用GetStaticIntField函数获取Java 静态int型字段的值，用GetStaticLongField函数获取Java 静态long字段的值，用GetStaticObjectField函数获取Java静态引用类型字段的值</type></p>
<p>示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">Java代码：</div><div class="line"></div><div class="line">public class Person &#123;</div><div class="line">​    public String name;</div><div class="line">​    public int age;</div><div class="line"></div><div class="line">    public static String name_static;</div><div class="line">    public static int age_static;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public native void getJavaObjectStaticField(Person person);</div><div class="line"></div><div class="line">private void test()&#123;</div><div class="line">​    Person.name_static=&quot;wubb&quot;;</div><div class="line">​    Person.age_static=20;</div><div class="line"></div><div class="line">    Person person=new Person();</div><div class="line">    getJavaObjectStaticField(person);</div><div class="line">&#125;</div><div class="line"></div><div class="line">JNI代码：</div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_getJavaObjectStaticField(JNIEnv* env, jobject thiz,jobject person) &#123;</div><div class="line">​    jclass clazz=env-&gt;GetObjectClass(person);</div><div class="line">​    jfieldID name_fieldID=env-&gt;GetStaticFieldID(clazz,&quot;name_static&quot;,&quot;Ljava/lang/String;&quot;);</div><div class="line">​    jstring name=(jstring) env-&gt;GetStaticObjectField(clazz,name_fieldID);</div><div class="line"></div><div class="line">    jfieldID age_fieldID=env-&gt;GetStaticFieldID(clazz,&quot;age_static&quot;,&quot;I&quot;);</div><div class="line">    jint age=env-&gt;GetStaticIntField(clazz,age_fieldID);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>JNI线程同步相关的函数</p>
<p>JNI可以使用Java对象进行线程同步</p>
<p>MonitorEnter函数用来锁定Java对象</p>
<p>MonitorExit函数用来释放Java对象锁</p>
<p>示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Java代码:</div><div class="line"></div><div class="line">jniLock(new Object());</div><div class="line"></div><div class="line">JNI代码：</div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_jniLock(JNIEnv* env, jobject thiz,jobject obj) &#123;</div><div class="line">​    env-&gt;MonitorEnter(obj);</div><div class="line">​    //do something</div><div class="line">​    env-&gt;MonitorExit(obj);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>JNI异常相关的函数</p>
<p>JNI处理Java异常</p>
<p>当JNI函数调用的Java方法出现异常的时候，并不会影响JNI方法的执行，但是我们并不推荐JNI函数忽略Java方法出现的异常继续执行，这样可能会带来更多的问题。我们推荐的方法是，当JNI函数调用的Java方法出现异常的时候，JNI函数应该合理的停止执行代码。</p>
<p>ExceptionOccurred函数用来判断JNI函数调用的Java方法是否出现异常</p>
<p>ExceptionClear函数用来清除JNI函数调用的Java方法出现的异常</p>
<p>请看如下示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">Java代码</div><div class="line"></div><div class="line">public void helloWorld()&#123;</div><div class="line">​    throw new NullPointerException(&quot;null pointer occurred&quot;);</div><div class="line">​    //Log.i(&quot;hello&quot;,&quot;hello world&quot;);</div><div class="line">&#125;</div><div class="line">C++代码</div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_callJavaHelloWorld(JNIEnv* env, jobject thiz) &#123;</div><div class="line">​    jclass clazz=env-&gt;GetObjectClass(thiz);</div><div class="line">​    if(clazz==NULL) return;</div><div class="line">​    jmethodID helloWorld_methodID=env-&gt;GetMethodID(clazz,&quot;helloWorld&quot;,&quot;()V&quot;);</div><div class="line">​    if(helloWorld_methodID==NULL) return;</div><div class="line">​    env-&gt;CallVoidMethod(thiz,helloWorld_methodID);</div><div class="line">​    if(env-&gt;ExceptionOccurred()!=NULL)&#123;</div><div class="line">​        env-&gt;ExceptionClear();</div><div class="line">​        __android_log_print(ANDROID_LOG_VERBOSE,&quot;hello&quot;,&quot;%s&quot;,&quot;program end with java exception&quot;);</div><div class="line">​        return;</div><div class="line">​    &#125;</div><div class="line">​    __android_log_print(ANDROID_LOG_VERBOSE,&quot;hello&quot;,&quot;%s&quot;,&quot;program end normallly&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>JNI抛出Java类型的异常</p>
<p>JNI通过ThrowNew函数抛出Java类型的异常</p>
<p>示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Java代码</div><div class="line"></div><div class="line">try</div><div class="line">&#123;</div><div class="line">​    testNativeException();</div><div class="line">&#125;</div><div class="line">catch (NullPointerException e)&#123;</div><div class="line">​    e.printStackTrace();</div><div class="line">&#125;</div><div class="line">C++代码</div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_testNativeException(JNIEnv* env, jobject thiz) &#123;</div><div class="line">​    jclass clazz=env-&gt;FindClass(&quot;java/lang/NullPointerException&quot;);</div><div class="line">​    if(clazz==NULL) return;</div><div class="line">​    env-&gt;ThrowNew(clazz,&quot;null pointer exception occurred&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>JNI对象的全局引用和局部引用</p>
<p>我们知道Java代码的内存是由垃圾回收器来管理，而JNI代码则不受Java的垃圾回收器来管理，所以JNI代码提供了一组函数，来管理通过JNI代码生成的JNI对象，比如jobject，jclass，jstring，jarray等，对于这些对象，我们不能简单的在JNI代码里面声明一个全局变量，然后把JNI对象赋值给全局变量，我们需要采用JNI代码提供的专有函数来管理这些全局的JNI对象。</p>
<p>JNI对象的局部引用</p>
<p>在JNI接口函数中引用JNI对象的局部变量，都是对JNI对象的局部引用，一旦JNI接口函数返回，所有这些JNI对象都会被自动释放。不过我们也可以采用JNI代码提供的DeleteLocalRef函数来删除一个局部JNI对象引用<br>请看下面的示例代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_testDeleteLocalRef(JNIEnv* env, jobject thiz) &#123;</div><div class="line">​    jclass clazz=env-&gt;GetObjectClass(thiz);</div><div class="line">​    if(clazz==NULL) return;</div><div class="line">​    jmethodID helloWorld_methodID=env-&gt;GetMethodID(clazz,&quot;helloWorld&quot;,&quot;()V&quot;);</div><div class="line">​    if(helloWorld_methodID==NULL) return;</div><div class="line">   env-&gt;CallVoidMethod(thiz,helloWorld_methodID);</div><div class="line">​    env-&gt;DeleteLocalRef(clazz);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>JNI对象的全局引用</p>
<p>对于JNI对象，绝对不能简单的声明一个全局变量，在JNI接口函数里面给这个全局变量赋值这么简单，一定要使用JNI代码提供的管理JNI对象的函数，否则代码可能会出现预想不到的问题。JNI对象的全局引用分为两种，一种是强全局引用，这种引用会阻止Java的垃圾回收器回收JNI代码引用的Java对象，另一种是弱全局引用，这种全局引用则不会阻止垃圾回收器回收JNI代码引用的Java对象。</p>
<p>强全局引用</p>
<p>NewGlobalRef用来创建强全局引用的JNI对象</p>
<p>DeleteGlobalRef用来删除强全局引用的JNI对象</p>
<p>示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">jobject gThiz;</div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_testStrongGlobalRef(JNIEnv* env, jobject thiz) &#123;</div><div class="line">​    //gThiz=thiz;//不能这样给全局JNI对象赋值，要采用下面这种方式</div><div class="line">​    gThiz=env-&gt;NewGlobalRef(thiz);//生成全局的JNI对象引用，这样生成的全局的JNI对象才可以在其它函数中使用</div><div class="line"></div><div class="line">    env-&gt;DeleteGlobalRef(gThiz);//假如我们不需要gThiz这个全局的JNI对象引用，我们可以把它删除掉</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>弱全局引用</p>
<p>NewWeakGlobalRef用来创建弱全局引用的JNI对象</p>
<p>DeleteWeakGlobalRef用来删除弱全局引用的JNI对象</p>
<p>IsSameObject用来判断两个JNI对象是否相同</p>
<p>示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">jobject gThiz;</div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_testWeakGlobalRef(JNIEnv*env, jobject thiz) &#123;</div><div class="line">​    //gThiz=thiz;//不能这样给全局JNI对象赋值，要采用下面这种方式</div><div class="line">​    gThiz=env-&gt;NewWeakGlobalRef(thiz);//生成全局的JNI对象引用，这样生成的全局的JNI对象才可以在其它函数中使用</div><div class="line"></div><div class="line">    if(env-&gt;IsSameObject(gThiz,NULL))&#123;</div><div class="line">        //弱全局引用已经被Java的垃圾回收器回收</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    env-&gt;DeleteWeakGlobalRef(gThiz);//假如我们不需要gThiz这个全局的JNI对象引用，我们可以把它删除掉</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Java代码和JNI代码通信</p>
<p>Java通过JNI接口调用C/C++方法</p>
<p>首先我们需要在Java代码里面声明Native方法原型，比如：</p>
<p>public native void helloJNI(String msg);</p>
<p>其次我们需要在C/C++代码里面声明JNI方法原型，比如：</p>
<p>extern “C”<br>JNIEXPORT void JNICALL<br>Java_com_kgdwbb_jnistudy_MainActivity_helloJNI(JNIEnv* env, jobject thiz,jstring msg) {<br>​    //do something<br>}<br>现在这段JNI函数声明代码采用的是C++语言写的，所以需要添加extern “C”声明，如果源代码是C语言，则不需要添加这个声明。</p>
<p>JNIEXPORT 这个关键字说明这个函数是一个可导出函数，学过C/C++的朋友都知道，C/C++ 库里面的函数有些可以直接被外部调用，有些不可以，原因就是每一个C/C++库都有一个导出函数列表，只有在这个列表里面的函数才可以被外部直接调用，类似Java的public函数和private函数的区别。</p>
<p>JNICALL 说明这个函数是一个JNI函数，用来和普通的C/C++函数进行区别，实际发现不加这个关键字，Java也是可以调用这个JNI函数的。</p>
<p>Void 说明这个函数的返回值是void，如果需要返回值，则把这个关键字替换成要返回的类型即可。</p>
<p>Java_com_kgdwbb_jnistudy_MainActivity_helloJNI(JNIEnv*env, jobject thiz,jstring msg)这是完整的JNI函数声明，JNI函数名的原型如下：</p>
<p>Java<em> + JNI方法所在的完整的类名，把类名里面的”.”替换成”</em>” + 真实的JNI方法名，这个方法名要和Java代码里面声明的JNI方法名一样+ JNI函数必须的默认参数(JNIEnv* env, jobjectthiz)</p>
<p>env参数是一个指向JNIEnv函数表的指针，</p>
<p>thiz参数代表的就是声明这个JNI方法的Java类的引用</p>
<p>msg参数就是和Java声明的JNI函数的msg参数对于的JNI函数参数</p>
<p>JNI函数的原型</p>
<p>[extern “C”]JNIEXPORT 函数返回值 JNICALL 完整的函数声明(JNIENV *env, jobject thiz, …)</p>
<p>其中extern “C”根据需要动态添加，如果是C++代码，则必须要添加extern “C”声明，如果是C代码，则不用添加</p>
<p>静态JNI方法和实例JNI方法区别</p>
<p>先看一个示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">Java代码：</div><div class="line"></div><div class="line">public native void showHello();</div><div class="line">public native static void showHello2();</div><div class="line">C++代码：</div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_showHello(JNIEnv* env, jobject thiz) &#123;</div><div class="line">​    //do something</div><div class="line">&#125;</div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_showHello2(JNIEnv* env, jclass thiz) &#123;</div><div class="line">​    //do something</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>相信明眼的同学很快就能发现这两个JNI函数的区别，对就是这个区别，普通的JNI方法对应的JNI函数的第二个参数是jobject类型，而静态的JNI方法对应的JNI函数的第二个参数是jclass类型</p>
<p>常见的Java JNI方法声明和JNI函数声明示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">Java Native方法声明：</div><div class="line"></div><div class="line">public class Person&#123;</div><div class="line">​    public String name;</div><div class="line">​    public int age;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public native void helloJNI(String msg);</div><div class="line">public native int func1(int a,int b);</div><div class="line">public native String func2(String str);</div><div class="line">public native void func3(boolean b);</div><div class="line">public native void func4(Person person);</div><div class="line">public native static void func5();</div><div class="line"></div><div class="line">C++JNI函数声明：</div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_helloJNI(JNIEnv* env, jobject thiz,jstring msg) &#123;</div><div class="line">​    //do something</div><div class="line">&#125;</div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT jint JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_func1(JNIEnv* env, jobject thiz,jint a,jint b) &#123;</div><div class="line">​    //do something</div><div class="line">&#125;</div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT jstring JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_func2(JNIEnv* env, jobject thiz,jstring str) &#123;</div><div class="line">​    //do something</div><div class="line">&#125;</div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_func3(JNIEnv* env, jobject thiz,jboolean b) &#123;</div><div class="line">​    //do something</div><div class="line">&#125;</div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_func4(JNIEnv* env, jobject thiz,jobject person) &#123;</div><div class="line">​    //do something</div><div class="line">&#125;</div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_func5(JNIEnv* env, jclass thiz) &#123;</div><div class="line">​    //do something</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所有的Java类对象在JNI函数里面都使用jobject来表示</p>
<p>JNI代码和Java代码通信</p>
<p>C++调用Java实例方法示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">Java代码</div><div class="line"></div><div class="line">public native void callJavaHelloWorld();</div><div class="line">public native void callJavaHelloWorld2();</div><div class="line">public native void callJavaHelloWorld3();</div><div class="line"></div><div class="line"></div><div class="line">public void helloWorld()&#123;</div><div class="line">​    Log.i(&quot;hello&quot;,&quot;helloworld&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">public void helloWorld2(String msg)&#123;</div><div class="line">​    Log.i(&quot;hello&quot;,&quot;helloworld &quot;+msg);</div><div class="line">&#125;</div><div class="line"></div><div class="line">public void helloWorld3(inta,int b)&#123;</div><div class="line">​    int c=a+b;</div><div class="line">​    Log.i(&quot;hello&quot;,&quot;helloworld c=&quot;+c);</div><div class="line">&#125;</div><div class="line"></div><div class="line">C++代码</div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_callJavaHelloWorld(JNIEnv* env, jobject thiz) &#123;</div><div class="line">​    jclass clazz=env-&gt;GetObjectClass(thiz);</div><div class="line">​    if(clazz==NULL) return;</div><div class="line">​    jmethodID helloWorld_methodID=env-&gt;GetMethodID(clazz,&quot;helloWorld&quot;,&quot;()V&quot;);</div><div class="line">​    if(helloWorld_methodID==NULL) return;</div><div class="line">​    env-&gt;CallVoidMethod(thiz,helloWorld_methodID);</div><div class="line">&#125;</div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_callJavaHelloWorld2(JNIEnv* env, jobject thiz) &#123;</div><div class="line">​    jclass clazz=env-&gt;GetObjectClass(thiz);</div><div class="line">​    if(clazz==NULL) return;</div><div class="line">​    jmethodID helloWorld2_methodID=env-&gt;GetMethodID(clazz,&quot;helloWorld2&quot;,&quot;(java/lang/String;)V&quot;);</div><div class="line">​    if(helloWorld2_methodID==NULL) return;</div><div class="line">​    const char *msg=&quot;hello world&quot;;</div><div class="line">​    jstring jmsg=env-&gt;NewStringUTF(msg);</div><div class="line">​    env-&gt;CallVoidMethod(thiz,helloWorld2_methodID,jmsg);</div><div class="line">&#125;</div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_callJavaHelloWorld3(JNIEnv* env, jobject thiz) &#123;</div><div class="line">​    jclass clazz=env-&gt;GetObjectClass(thiz);</div><div class="line">​    if(clazz==NULL) return;</div><div class="line">​    jmethodID helloWorld3_methodID=env-&gt;GetMethodID(clazz,&quot;helloWorld3&quot;,&quot;(II)V&quot;);</div><div class="line">​    if(helloWorld3_methodID==NULL) return;</div><div class="line">​    env-&gt;CallVoidMethod(clazz,helloWorld3_methodID,2,3);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>C++调用Java静态方法示例</p>
<p>Java代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">public native void callStaticJavaHelloWorld();</div><div class="line">public native void callStaticJavaHelloWorld2();</div><div class="line">public native void callStaticJavaHelloWorld3();</div><div class="line"></div><div class="line">public static void helloWorldStatic()&#123;</div><div class="line">​    Log.i(&quot;hello&quot;,&quot;helloworld static&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">public static void helloWorldStatic2(String msg)&#123;</div><div class="line">​    Log.i(&quot;hello&quot;,&quot;helloworld static &quot;+msg);</div><div class="line">&#125;</div><div class="line"></div><div class="line">public static void helloWorldStatic3(inta,int b)&#123;</div><div class="line">​    int c=a+b;</div><div class="line">​    Log.i(&quot;hello&quot;,&quot;helloworld static c=&quot;+c);</div><div class="line">&#125;</div><div class="line"></div><div class="line">C++代码</div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_callStaticJavaHelloWorld(JNIEnv* env, jobject thiz) &#123;</div><div class="line">​    jclass clazz=env-&gt;GetObjectClass(thiz);</div><div class="line">​    if(clazz==NULL) return;</div><div class="line">​    jmethodID helloWorldStatic_methodID=env-&gt;GetStaticMethodID(clazz,&quot;helloWorldStatic&quot;,&quot;()V&quot;);</div><div class="line">​    if(helloWorldStatic_methodID==NULL) return;</div><div class="line">​    env-&gt;CallStaticVoidMethod(clazz,helloWorldStatic_methodID);</div><div class="line">&#125;</div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_callStaticJavaHelloWorld2(JNIEnv* env, jobject thiz) &#123;</div><div class="line">​    jclass clazz=env-&gt;GetObjectClass(thiz);</div><div class="line">​    if(clazz==NULL) return;</div><div class="line">​    jmethodID helloWorldStatic2_methodID=env-&gt;GetStaticMethodID(clazz,&quot;helloWorldStatic2&quot;,&quot;(java/lang/String;)V&quot;);</div><div class="line">​    if(helloWorldStatic2_methodID==NULL) return;</div><div class="line">​    const char *msg=&quot;hello world&quot;;</div><div class="line">​    jstring jmsg=env-&gt;NewStringUTF(msg);</div><div class="line">​    env-&gt;CallStaticVoidMethod(clazz,helloWorldStatic2_methodID,msg);</div><div class="line">&#125;</div><div class="line"></div><div class="line">extern &quot;C&quot;</div><div class="line">JNIEXPORT void JNICALL</div><div class="line">Java_com_kgdwbb_jnistudy_MainActivity_callStaticJavaHelloWorld3(JNIEnv* env, jobject thiz) &#123;</div><div class="line">​    jclass clazz=env-&gt;GetObjectClass(thiz);</div><div class="line">​    if(clazz==NULL) return;</div><div class="line">​    jmethodID helloWorldStatic3_methodID=env-&gt;GetStaticMethodID(clazz,&quot;helloWorldStatic3&quot;,&quot;(II)V&quot;);</div><div class="line">​    if(helloWorldStatic3_methodID==NULL) return;</div><div class="line">​    env-&gt;CallStaticVoidMethod(clazz,helloWorldStatic3_methodID,2,3);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

      
    </div>

  </div>

  <!-- id 将作为查询条件 -->
  
  <div align="right" hidden=true>
    <span id="tech/jni.html" class="leancloud-visitors" data-flag-title="JNI">
        <em class="post-meta-item-text">阅读量: </em>
        <i class="leancloud-visitors-count">10</i>
    </span>
    </script>
  </div>
  


  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/tech/">技术</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/C/">C++</a>
    </span>
    
    </div>
  </div>

  
                <div class="reward">
       <div id="donate-btn" class="reward-button">赏 <span class="reward-code">
      <span id="donate-code" class="wechat-code"> <img class="wechat-img wdp-appear" src="https://raw.githubusercontent.com/Goverse/Goverse.github.io/master/images/wechat_donate.jpeg"><b>微信打赏</b> </span>
       </div>
      <p class="reward-notice">打赏1元，感激不尽!</p>
</div>
<script type="text/javascript">
		document.getElementById('donate-btn').onclick = function(){
      if($("#donate-code").is(":hidden")) //已经是隐藏状态
      {
        $('#donate-code').removeClass('hidden');
      } else {
        $('#donate-code').addClass('hidden');
      }
		}
</script>

              
                <!-- 添加Valine评论 -->
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min.js"></script>
<script src='//cdn.jsdelivr.net/npm/valine/dist/Valine.min.js'></script>
<div
		id="vcomments"
		style="margin-top:20px;"
		></div>
		<script>
				new Valine({
						el: '#vcomments',
						appId: 'zqMC1nUx49CRvrVNiC2i5jMz-gzGzoHsz',
						appKey: 'KNWfOWw8fHOfdmHFQdkKa8C7',
						notify: false,
						verify: false,
						visitor: true, // 阅读量统计
						avatar: 'mm',
						placeholder: '来吧，一起讨论讨论，共同进步~~~'
				})
		</script>
<!-- 添加Valine评论 -->

              
</article>

    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2019 Goverse&#39;Blog
    
  </p>
  <p>Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></p>
</footer>

    
  <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?bf97bef94fa19c674f5640f47e01d001";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
  </script>



  </div>
</div>
</body>
</html>
